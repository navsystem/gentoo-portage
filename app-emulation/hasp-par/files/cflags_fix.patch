diff -u a/Makefile b/Makefile
--- a/Makefile	2007-01-08 23:09:11.000000000 +0300
+++ b/Makefile	2008-06-23 17:10:01.000000000 +0400
@@ -11,13 +11,13 @@
 TARGETARCH := $(shell uname -m | sed -e s/i.86/x86/)
 
 HLMOD_DEFINES  := -DHL_MAJOR=42 -DCPC_PCI
+MODULE_DEFINES := -D__KERNEL__ -DMODULE
 
 CC            = gcc
 
-ifndef CFLAGS
-CFLAGS        = $(MODULE_DEFINES) $(HLMOD_DEFINES)
+ifndef EXTRA_CFLAGS
+EXTRA_CFLAGS        = $(MODULE_DEFINES) $(HLMOD_DEFINES)
 endif
-MODULE_DEFINES := -D__KERNEL__ -DMODULE
 
 CFLAGS.x86    = $(LINUX_COPTS) $(LINUX_DEFINE) $(LINUX_I386_OPTS) $(LINUX_I386_KERN_OPTS)
 CFLAGS.alpha  = $(LINUX_COPTS) $(LINUX_DEFINE) $(LINUX_ALPHA_OPTS) $(LINUX_ALPHA_KERN_OPTS)
@@ -25,7 +25,7 @@
 CFLAGS.ppc    = $(LINUX_COPTS) $(LINUX_DEFINE) $(LINUX_PPC_OPTS) $(LINUX_PPC_KERN_OPTS)
 CFLAGS.x86_64 = $(LINUX_COPTS) $(LINUX_DEFINE) $(LINUX_AMD64_OPTS) $(LINUX_AMD64_KERN_OPTS)
 
-CFLAGS        += $(CFLAGS.$(TARGETARCH))
+EXTRA_CFLAGS        += $(CFLAGS.$(TARGETARCH))
 
 help:
 	@echo "usage:	$(MAKE) KERNSRC=kernelsourcedir kernel26"
@@ -41,11 +41,15 @@
 ifdef TOPDIR
 obj-m        = aksparlnx.o
 endif
+
+$(obj-m):
+%.o: %.c
+	$(CC) $(EXTRA_CFLAGS) $(CFLAGS) -c $< -o $@ 
+
 aksparlnx-objs     =  aksparpub.o api.o
 
 # ------------------------------ 2.6.x ------------------------------
 
-EXTRA_CFLAGS := $(MODULE_DEFINES) $(HLMOD_DEFINES)
 
 kernel26:
 	$(MAKE) -C $(KERNSRC) here=$$(pwd)/ SUBDIRS=$$(pwd) modules
@@ -59,7 +63,7 @@
 	ld -r -x -o $@ api24.o aksparpub.o
 
 aksparpub.o: aksparpub.h aksport.h akstypes.h fastapi.h unix_ioctl.h aksparpub.c
-	$(CC) $(CFLAGS) -I $(KERNSRC)/include -c aksparpub.c -o $@
+	$(CC) $(EXTRA_CFLAGS) $(CFLAGS) -I $(KERNSRC)/include -c aksparpub.c -o $@
 
 kernel24:
 	$(MAKE) -C $(KERNSRC) here=$$(pwd)/ SUBDIRS=$$(pwd) modules
